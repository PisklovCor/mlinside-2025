name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    runs-on: ubuntu-latest

    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
        run: |
          cd CryptoMultiagent
          mvn clean compile

      - name: –°–æ–∑–¥–∞–Ω–∏–µ JAR —Ñ–∞–π–ª–∞
        run: |
          cd CryptoMultiagent
          mvn package -DskipTests

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: CryptoMultiagent/target/*.jar
          retention-days: 30

  test:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: CryptoMultiagent/target/

      - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
        run: |
          cd CryptoMultiagent
          mvn test
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ –æ —Ç–µ—Å—Ç–∞—Ö
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: CryptoMultiagent/target/surefire-reports/
          retention-days: 30

  docker-build:
    name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: CryptoMultiagent/target/

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
        run: |
          cd CryptoMultiagent
          docker build -f docker/Dockerfile -t crypto-multiagent:latest .
          docker tag crypto-multiagent:latest crypto-multiagent:${{ github.sha }}

      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞
        run: |
          cd CryptoMultiagent
          docker save crypto-multiagent:latest | gzip > crypto-multiagent.tar.gz

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–∞
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: CryptoMultiagent/crypto-multiagent.tar.gz
          retention-days: 30

  docker-push:
    name: Push –≤ Docker Hub
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
        run: |
          if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "‚ùå DOCKER_USERNAME –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "‚ùå DOCKER_PASSWORD –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã Docker –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–∞
        run: |
          gunzip -c crypto-multiagent.tar.gz | docker load

      - name: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ Docker Hub..."
          docker info | grep Username || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"

      - name: Push –æ–±—Ä–∞–∑–∞ –≤ Docker Hub
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          echo "Docker username: $DOCKER_USER"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞
          docker images | grep crypto-multiagent || (echo "‚ùå –û–±—Ä–∞–∑ crypto-multiagent –Ω–µ –Ω–∞–π–¥–µ–Ω" && exit 1)
          
          # –¢–µ–≥–∏—Ä—É–µ–º –æ–±—Ä–∞–∑ —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Docker Hub
          docker tag crypto-multiagent:latest "${DOCKER_USER}/crypto-multiagent:latest"
          docker tag crypto-multiagent:latest "${DOCKER_USER}/crypto-multiagent:${{ github.sha }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏
          docker images | grep "${DOCKER_USER}/crypto-multiagent"
          
          # –ü—É—à–∏–º –æ–±—Ä–∞–∑—ã –≤ Docker Hub (—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
          echo "Pushing latest tag (—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)..."
          docker push "${DOCKER_USER}/crypto-multiagent:latest"
          
          echo "Pushing SHA tag..."
          docker push "${DOCKER_USER}/crypto-multiagent:${{ github.sha }}"
          
          echo "‚úÖ –û–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ Docker Hub"
          echo "üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://hub.docker.com/r/${DOCKER_USER}/crypto-multiagent"